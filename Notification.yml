---
- name: Create L4 TCP Load Balancer (Dynamic - Fixed) with AWX Notifications
  hosts: localhost
  gather_facts: no
  collections:
    - openstack.cloud

  vars:
    cloud_name: openstack
    lb_name: awx-test-lb-l4-corretto
    lb_vip_subnet: "d126b00a-8fab-48b4-bc55-0f05c6aacc8e"
    listener_name: tcp-listener
    listener_port: 8080
    pool_name: tcp-pool
    lb_algorithm: ROUND_ROBIN
    protocol: TCP
    lb_members:
      - address: 10.0.0.11
        protocol_port: 8080
      - address: 10.0.0.12
        protocol_port: 8080

  tasks:

    - name: ğŸ”” Notify - Job started
      uri:
        url: "{{ tower_host }}/api/v2/activity_stream/"
        method: POST
        headers:
          Authorization: "Bearer {{ tower_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          operation: "create"
          object1: "Job"
          object2: "{{ lb_name }}"
          changes: "ğŸš€ Job started: creating Load Balancer '{{ lb_name }}'"
        status_code: 201
      ignore_errors: yes

    - name: ğŸ” Validate required variables
      assert:
        that:
          - lb_name is defined
          - lb_vip_subnet is defined
          - listener_port is defined
          - lb_members is defined
          - lb_members | length > 0
        fail_msg: "âŒ Variabili richieste mancanti!"

    - name: ğŸ§¾ Log configuration
      debug:
        msg: |
          ğŸ“‹ Configurazione Load Balancer
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸŒ Cloud: {{ cloud_name }}
          ğŸ“› Nome: {{ lb_name }}
          ğŸ§© Subnet VIP: {{ lb_vip_subnet }}
          âš™ï¸  Algoritmo: {{ lb_algorithm }}
          ğŸ”Œ Porta: {{ listener_port }}
          ğŸ–¥ï¸  Membri: {{ lb_members | length }}
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    - name: ğŸ”” Notify - Cleanup start
      uri:
        url: "{{ tower_host }}/api/v2/activity_stream/"
        method: POST
        headers:
          Authorization: "Bearer {{ tower_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          operation: "update"
          object1: "Cleanup"
          object2: "{{ lb_name }}"
          changes: "ğŸ§¹ Checking for existing Load Balancer '{{ lb_name }}'"
        status_code: 201
      ignore_errors: yes

    - name: ğŸ§¹ Ensure no existing load balancer (cleanup)
      openstack.cloud.loadbalancer:
        cloud: "{{ cloud_name }}"
        name: "{{ lb_name }}"
        state: absent
        wait: yes
        timeout: 300
      ignore_errors: yes

    - name: ğŸ—ï¸ Create Load Balancer
      openstack.cloud.loadbalancer:
        cloud: "{{ cloud_name }}"
        name: "{{ lb_name }}"
        vip_subnet: "{{ lb_vip_subnet }}"
        state: present
        wait: yes
        timeout: 800
      register: lb_created

    - name: ğŸ”” Notify - LB created
      uri:
        url: "{{ tower_host }}/api/v2/activity_stream/"
        method: POST
        headers:
          Authorization: "Bearer {{ tower_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          operation: "create"
          object1: "LoadBalancer"
          object2: "{{ lb_name }}"
          changes: "âœ… Load Balancer '{{ lb_name }}' creato con successo"
        status_code: 201
      ignore_errors: yes

    - name: ğŸ§ Create Listener
      openstack.cloud.lb_listener:
        cloud: "{{ cloud_name }}"
        load_balancer: "{{ lb_name }}"
        name: "{{ listener_name }}"
        protocol: "{{ protocol }}"
        protocol_port: "{{ listener_port }}"
        state: present
        wait: yes
        timeout: 120
      register: listener_created

    - name: ğŸ”” Notify - Listener created
      uri:
        url: "{{ tower_host }}/api/v2/activity_stream/"
        method: POST
        headers:
          Authorization: "Bearer {{ tower_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          operation: "create"
          object1: "Listener"
          object2: "{{ listener_name }}"
          changes: "âœ… Listener '{{ listener_name }}' creato sulla porta {{ listener_port }}"
        status_code: 201
      ignore_errors: yes

    - name: ğŸ§© Create Pool
      openstack.cloud.lb_pool:
        cloud: "{{ cloud_name }}"
        listener: "{{ listener_name }}"
        name: "{{ pool_name }}"
        protocol: "{{ protocol }}"
        lb_algorithm: "{{ lb_algorithm }}"
        state: present
        wait: yes
        timeout: 120
      register: pool_created

    - name: ğŸ”” Notify - Pool created
      uri:
        url: "{{ tower_host }}/api/v2/activity_stream/"
        method: POST
        headers:
          Authorization: "Bearer {{ tower_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          operation: "create"
          object1: "Pool"
          object2: "{{ pool_name }}"
          changes: "âœ… Pool '{{ pool_name }}' creato con algoritmo {{ lb_algorithm }}"
        status_code: 201
      ignore_errors: yes

    - name: ğŸ§± Add members to pool
      openstack.cloud.lb_member:
        cloud: "{{ cloud_name }}"
        pool: "{{ pool_name }}"
        name: "member-{{ item.address }}-{{ item.protocol_port }}"
        address: "{{ item.address }}"
        protocol_port: "{{ item.protocol_port }}"
        subnet_id: "{{ lb_vip_subnet }}"
        state: present
        wait: yes
      loop: "{{ lb_members }}"
      register: members_added

    - name: ğŸ”” Notify - Members added
      uri:
        url: "{{ tower_host }}/api/v2/activity_stream/"
        method: POST
        headers:
          Authorization: "Bearer {{ tower_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          operation: "update"
          object1: "PoolMembers"
          object2: "{{ pool_name }}"
          changes: "âœ… Aggiunti {{ lb_members | length }} membri al pool '{{ pool_name }}'"
        status_code: 201
      ignore_errors: yes

    - name: ğŸ” Retrieve Load Balancer info (OpenStack SDK)
      ansible.builtin.command: >
        python3 -c "import openstack, json;
        conn=openstack.connect(cloud='{{ cloud_name }}');
        lb=conn.load_balancer.find_load_balancer('{{ lb_name }}');
        import sys;
        sys.exit(1) if not lb else None;
        full=conn.load_balancer.get_load_balancer(lb);
        print(json.dumps({'name': full.name, 'vip_address': full.vip_address, 'vip_port_id': full.vip_port_id, 'id': full.id}))"
      register: lb_info_json
      changed_when: false
      failed_when: lb_info_json.rc != 0

    - name: Parse SDK output
      ansible.builtin.set_fact:
        lb_data: "{{ lb_info_json.stdout | from_json }}"

    - name: ğŸ“¦ Set output facts for workflow
      ansible.builtin.set_fact:
        lb_output:
          name: "{{ lb_data.name }}"
          vip_port_id: "{{ lb_data.vip_port_id }}"
          vip_address: "{{ lb_data.vip_address }}"
          id: "{{ lb_data.id }}"

    - name: ğŸ”” Notify - Job completed
      uri:
        url: "{{ tower_host }}/api/v2/activity_stream/"
        method: POST
        headers:
          Authorization: "Bearer {{ tower_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          operation: "complete"
          object1: "Job"
          object2: "{{ lb_output.name }}"
          changes: "ğŸ¯ Job completato con successo. Load Balancer attivo su {{ lb_output.vip_address }}"
        status_code: 201
      ignore_errors: yes

    - name: ğŸ“œ Final summary
      debug:
        msg: |
          âœ…âœ…âœ… CREAZIONE LOAD BALANCER COMPLETATA âœ…âœ…âœ…
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ“› Nome: {{ lb_output.name }}
          ğŸ†” ID: {{ lb_output.id }}
          ğŸ”’ VIP Address: {{ lb_output.vip_address }}
          ğŸ”Œ VIP Port ID: {{ lb_output.vip_port_id }}
          ğŸ§ Listener: {{ listener_name }}
          ğŸ§© Pool: {{ pool_name }}
          ğŸ–¥ï¸  Backend Members:
          {% for member in lb_members %}
              - {{ member.address }}:{{ member.protocol_port }}
          {% endfor %}
          âš–ï¸  Algoritmo: {{ lb_algorithm }}
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
