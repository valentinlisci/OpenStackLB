---
- name: Deploy Load Balancer via Octavia (API OpenStack LBaaS)
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:

    - name: Mostra variabili dâ€™ambiente nel container di esecuzione
      shell: env | grep OS_
      register: env_out

    - debug:
        var: env_out.stdout_lines

    - name: Rimuovi eventuale Load Balancer esistente
      openstack.cloud.loadbalancer:
        auth:
          auth_url: "{{ lookup('env', 'OS_AUTH_URL') }}"
          username: "{{ lookup('env', 'OS_USERNAME') }}"
          password: "{{ lookup('env', 'OS_PASSWORD') }}"
          project_name: "{{ lookup('env', 'OS_PROJECT_NAME') }}"
          user_domain_name: "{{ lookup('env', 'OS_USER_DOMAIN_NAME') }}"
          project_domain_name: "{{ lookup('env', 'OS_PROJECT_DOMAIN_NAME') }}"
        region_name: "{{ lookup('env', 'OS_REGION_NAME') }}"
        state: absent
        name: test-lb
      ignore_errors: true

    - name: Crea Load Balancer (Octavia)
      openstack.cloud.loadbalancer:
        auth:
          auth_url: "{{ lookup('env', 'OS_AUTH_URL') }}"
          username: "{{ lookup('env', 'OS_USERNAME') }}"
          password: "{{ lookup('env', 'OS_PASSWORD') }}"
          project_name: "{{ lookup('env', 'OS_PROJECT_NAME') }}"
          user_domain_name: "{{ lookup('env', 'OS_USER_DOMAIN_NAME') }}"
          project_domain_name: "{{ lookup('env', 'OS_PROJECT_DOMAIN_NAME') }}"
        region_name: "{{ lookup('env', 'OS_REGION_NAME') }}"
        state: present
        name: lb_test
        vip_network: lb-mgmt-net
        wait: yes

    - name: Mostra il Load Balancer creato
      openstack.cloud.loadbalancer_info:
        auth:
          auth_url: "{{ lookup('env', 'OS_AUTH_URL') }}"
          username: "{{ lookup('env', 'OS_USERNAME') }}"
          password: "{{ lookup('env', 'OS_PASSWORD') }}"
          project_name: "{{ lookup('env', 'OS_PROJECT_NAME') }}"
          user_domain_name: "{{ lookup('env', 'OS_USER_DOMAIN_NAME') }}"
          project_domain_name: "{{ lookup('env', 'OS_PROJECT_DOMAIN_NAME') }}"
        region_name: "{{ lookup('env', 'OS_REGION_NAME') }}"
        name: lb_test
      register: lb_info

    - debug:
        var: lb_info
